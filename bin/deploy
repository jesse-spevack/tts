#!/bin/bash
set -e

echo "================================"
echo "Deploying to Cloud Run"
echo "================================"

# Load environment variables
if [ -f .env ]; then
    source .env
else
    echo "Error: .env file not found"
    exit 1
fi

# Validate required vars
if [ -z "$GOOGLE_CLOUD_PROJECT" ] || [ -z "$GOOGLE_CLOUD_BUCKET" ] || [ -z "$API_SECRET_TOKEN" ]; then
    echo "Error: Required environment variables not set"
    echo "Check .env for: GOOGLE_CLOUD_PROJECT, GOOGLE_CLOUD_BUCKET, API_SECRET_TOKEN"
    exit 1
fi

REGION=${CLOUD_TASKS_LOCATION:-us-central1}

echo ""
echo "Project: $GOOGLE_CLOUD_PROJECT"
echo "Region: $REGION"
echo "Bucket: $GOOGLE_CLOUD_BUCKET"
echo ""

# Deploy to Cloud Run
gcloud run deploy podcast-api \
    --source . \
    --project $GOOGLE_CLOUD_PROJECT \
    --region $REGION \
    --platform managed \
    --allow-unauthenticated \
    --memory 2Gi \
    --timeout 600s \
    --max-instances 1 \
    --min-instances 0 \
    --set-env-vars "GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT" \
    --set-env-vars "GOOGLE_CLOUD_BUCKET=$GOOGLE_CLOUD_BUCKET" \
    --set-env-vars "API_SECRET_TOKEN=$API_SECRET_TOKEN" \
    --set-env-vars "CLOUD_TASKS_LOCATION=$REGION" \
    --set-env-vars "CLOUD_TASKS_QUEUE=${CLOUD_TASKS_QUEUE:-episode-processing}"

# Get service URL
SERVICE_URL=$(gcloud run services describe podcast-api \
    --region $REGION \
    --project $GOOGLE_CLOUD_PROJECT \
    --format 'value(status.url)')

echo ""
echo "âœ“ Deployed successfully!"
echo "URL: $SERVICE_URL"
echo ""

# Update service with its own URL for Cloud Tasks
echo "Updating service with SERVICE_URL for Cloud Tasks..."
gcloud run services update podcast-api \
    --region $REGION \
    --project $GOOGLE_CLOUD_PROJECT \
    --set-env-vars "SERVICE_URL=$SERVICE_URL"

echo ""
echo "================================"
echo "Deployment Complete!"
echo "================================"
echo ""
echo "API URL: $SERVICE_URL"
echo ""
echo "Test health:"
echo "  curl $SERVICE_URL/health"
echo ""
echo "Publish episode:"
echo "  curl -X POST $SERVICE_URL/publish \\"
echo "    -H \"Authorization: Bearer \$API_SECRET_TOKEN\" \\"
echo "    -F \"title=Test Episode\" \\"
echo "    -F \"author=Your Name\" \\"
echo "    -F \"description=Test description\" \\"
echo "    -F \"content=@article.md\""
