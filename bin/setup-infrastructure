#!/bin/bash
set -e

echo "================================"
echo "Setting up Cloud Infrastructure"
echo "================================"

# Check if gcloud is installed
if ! command -v gcloud &> /dev/null; then
    echo "Error: gcloud CLI not installed"
    echo "Install from: https://cloud.google.com/sdk/docs/install"
    exit 1
fi

# Load environment variables
if [ -f .env ]; then
    source .env
else
    echo "Error: .env file not found"
    echo "Copy .env.example to .env and configure it"
    exit 1
fi

# Check required vars
if [ -z "$GOOGLE_CLOUD_PROJECT" ]; then
    echo "Error: GOOGLE_CLOUD_PROJECT not set in .env"
    exit 1
fi

PROJECT_ID=$GOOGLE_CLOUD_PROJECT
LOCATION=${CLOUD_TASKS_LOCATION:-us-central1}
QUEUE_NAME=${CLOUD_TASKS_QUEUE:-episode-processing}

echo ""
echo "Project: $PROJECT_ID"
echo "Location: $LOCATION"
echo "Queue: $QUEUE_NAME"
echo ""

# Enable APIs
echo "Enabling Google Cloud APIs..."
gcloud services enable run.googleapis.com --project=$PROJECT_ID 2>&1 | grep -v "^$" || true
gcloud services enable cloudtasks.googleapis.com --project=$PROJECT_ID 2>&1 | grep -v "^$" || true
echo "✓ APIs enabled"

# Create Cloud Tasks queue
echo ""
echo "Creating Cloud Tasks queue..."
if gcloud tasks queues describe $QUEUE_NAME --location=$LOCATION --project=$PROJECT_ID &> /dev/null; then
    echo "✓ Queue already exists: $QUEUE_NAME"
else
    echo "Creating queue (this may take 30-60 seconds)..."
    # Run queue creation in background with timeout handling
    gcloud tasks queues create $QUEUE_NAME \
        --location=$LOCATION \
        --project=$PROJECT_ID \
        --max-attempts=3 \
        --max-retry-duration=3600s 2>&1 &

    QUEUE_PID=$!
    TIMEOUT=120
    ELAPSED=0

    # Wait for process to complete or timeout
    while kill -0 $QUEUE_PID 2>/dev/null; do
        if [ $ELAPSED -ge $TIMEOUT ]; then
            kill $QUEUE_PID 2>/dev/null
            wait $QUEUE_PID 2>/dev/null
            echo "⚠ Queue creation timed out after ${TIMEOUT}s"
            echo "You can create it manually at:"
            echo "https://console.cloud.google.com/cloudtasks/queue/create?project=$PROJECT_ID&location=$LOCATION"
            echo "Queue name: $QUEUE_NAME"
            exit 1
        fi
        sleep 1
        ELAPSED=$((ELAPSED + 1))
    done

    # Check if process succeeded
    wait $QUEUE_PID
    if [ $? -eq 0 ]; then
        echo "✓ Queue created: $QUEUE_NAME"
    else
        echo "⚠ Queue creation failed"
        echo "You can create it manually at:"
        echo "https://console.cloud.google.com/cloudtasks/queue/create?project=$PROJECT_ID&location=$LOCATION"
        echo "Queue name: $QUEUE_NAME"
        exit 1
    fi
fi

echo ""
echo "================================"
echo "Infrastructure setup complete!"
echo "================================"
echo ""
echo "Next steps:"
echo "  1. Deploy service: ./bin/deploy"
echo "  2. Test the API with curl"
