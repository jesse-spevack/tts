name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

jobs:
  deploy-hub:
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch secrets from Secret Manager
        run: |
          echo "RAILS_MASTER_KEY=$(gcloud secrets versions access latest --secret=rails-master-key)" >> $GITHUB_ENV
          echo "RESEND_API_KEY=$(gcloud secrets versions access latest --secret=resend-api-key)" >> $GITHUB_ENV
          echo "APP_HOST=$(gcloud secrets versions access latest --secret=mailer-host)" >> $GITHUB_ENV
          echo "MAILER_FROM_ADDRESS=$(gcloud secrets versions access latest --secret=mailer-from-address)" >> $GITHUB_ENV
          echo "GOOGLE_CLOUD_BUCKET=$(gcloud secrets versions access latest --secret=google-cloud-bucket)" >> $GITHUB_ENV
          echo "GOOGLE_CLOUD_PROJECT=$(gcloud secrets versions access latest --secret=google-cloud-project)" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_EMAIL=$(gcloud secrets versions access latest --secret=service-account-email)" >> $GITHUB_ENV
          echo "VERTEX_AI_LOCATION=$(gcloud secrets versions access latest --secret=vertex-ai-location)" >> $GITHUB_ENV
          # Generate OAuth2 access token for Artifact Registry (instead of static secret)
          echo "KAMAL_REGISTRY_PASSWORD=$(gcloud auth print-access-token)" >> $GITHUB_ENV

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Add VM to known_hosts
        run: ssh-keyscan 34.106.61.4 >> ~/.ssh/known_hosts

      - name: Write Kamal secrets
        run: |
          cat > .kamal/secrets << EOF
          RAILS_MASTER_KEY=$RAILS_MASTER_KEY
          RESEND_API_KEY=$RESEND_API_KEY
          APP_HOST=$APP_HOST
          MAILER_FROM_ADDRESS=$MAILER_FROM_ADDRESS
          GOOGLE_CLOUD_BUCKET=$GOOGLE_CLOUD_BUCKET
          GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT
          SERVICE_ACCOUNT_EMAIL=$SERVICE_ACCOUNT_EMAIL
          VERTEX_AI_LOCATION=$VERTEX_AI_LOCATION
          KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD
          EOF

      - name: Deploy with Kamal
        run: bin/kamal deploy
