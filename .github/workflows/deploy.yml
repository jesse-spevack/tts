name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

jobs:
  detect-changes:
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      hub: ${{ steps.changes.outputs.hub }}
      generator: ${{ steps.changes.outputs.generator }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Get list of changed files
          CHANGED=$(git diff --name-only HEAD^ HEAD)

          # Check if hub files changed
          if echo "$CHANGED" | grep -q "^hub/"; then
            echo "hub=true" >> $GITHUB_OUTPUT
          else
            echo "hub=false" >> $GITHUB_OUTPUT
          fi

          # Check if generator files changed (anything outside hub/, docs/, .github/)
          if echo "$CHANGED" | grep -v "^hub/" | grep -v "^docs/" | grep -v "^\.github/" | grep -q .; then
            echo "generator=true" >> $GITHUB_OUTPUT
          else
            echo "generator=false" >> $GITHUB_OUTPUT
          fi

  deploy-hub:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.hub == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch secrets from Secret Manager
        run: |
          echo "RAILS_MASTER_KEY=$(gcloud secrets versions access latest --secret=rails-master-key)" >> $GITHUB_ENV
          echo "RESEND_API_KEY=$(gcloud secrets versions access latest --secret=resend-api-key)" >> $GITHUB_ENV
          echo "MAILER_HOST=$(gcloud secrets versions access latest --secret=mailer-host)" >> $GITHUB_ENV
          echo "MAILER_FROM_ADDRESS=$(gcloud secrets versions access latest --secret=mailer-from-address)" >> $GITHUB_ENV
          echo "CLOUD_TASKS_LOCATION=$(gcloud secrets versions access latest --secret=cloud-tasks-location)" >> $GITHUB_ENV
          echo "CLOUD_TASKS_QUEUE=$(gcloud secrets versions access latest --secret=cloud-tasks-queue)" >> $GITHUB_ENV
          echo "GENERATOR_CALLBACK_SECRET=$(gcloud secrets versions access latest --secret=generator-callback-secret)" >> $GITHUB_ENV
          echo "GENERATOR_SERVICE_URL=$(gcloud secrets versions access latest --secret=generator-service-url)" >> $GITHUB_ENV
          echo "GOOGLE_CLOUD_BUCKET=$(gcloud secrets versions access latest --secret=google-cloud-bucket)" >> $GITHUB_ENV
          echo "GOOGLE_CLOUD_PROJECT=$(gcloud secrets versions access latest --secret=google-cloud-project)" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_EMAIL=$(gcloud secrets versions access latest --secret=service-account-email)" >> $GITHUB_ENV
          echo "VERTEX_AI_LOCATION=$(gcloud secrets versions access latest --secret=vertex-ai-location)" >> $GITHUB_ENV
          # Generate OAuth2 access token for Artifact Registry (instead of static secret)
          echo "KAMAL_REGISTRY_PASSWORD=$(gcloud auth print-access-token)" >> $GITHUB_ENV

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          working-directory: hub
          bundler-cache: true

      - name: Add VM to known_hosts
        run: ssh-keyscan 34.106.61.4 >> ~/.ssh/known_hosts

      - name: Write Kamal secrets
        working-directory: hub
        run: |
          cat > .kamal/secrets << EOF
          RAILS_MASTER_KEY=$RAILS_MASTER_KEY
          RESEND_API_KEY=$RESEND_API_KEY
          MAILER_HOST=$MAILER_HOST
          MAILER_FROM_ADDRESS=$MAILER_FROM_ADDRESS
          CLOUD_TASKS_LOCATION=$CLOUD_TASKS_LOCATION
          CLOUD_TASKS_QUEUE=$CLOUD_TASKS_QUEUE
          GENERATOR_CALLBACK_SECRET=$GENERATOR_CALLBACK_SECRET
          GENERATOR_SERVICE_URL=$GENERATOR_SERVICE_URL
          GOOGLE_CLOUD_BUCKET=$GOOGLE_CLOUD_BUCKET
          GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT
          SERVICE_ACCOUNT_EMAIL=$SERVICE_ACCOUNT_EMAIL
          VERTEX_AI_LOCATION=$VERTEX_AI_LOCATION
          KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD
          EOF

      - name: Deploy with Kamal
        working-directory: hub
        run: bin/kamal deploy

  deploy-generator:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.generator == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch secrets from Secret Manager
        run: |
          echo "GOOGLE_CLOUD_PROJECT=$(gcloud secrets versions access latest --secret=google-cloud-project)" >> $GITHUB_ENV
          echo "GOOGLE_CLOUD_BUCKET=$(gcloud secrets versions access latest --secret=google-cloud-bucket)" >> $GITHUB_ENV
          echo "API_SECRET_TOKEN=$(gcloud secrets versions access latest --secret=api-secret-token)" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT_EMAIL=$(gcloud secrets versions access latest --secret=service-account-email)" >> $GITHUB_ENV
          echo "CLOUD_TASKS_LOCATION=$(gcloud secrets versions access latest --secret=cloud-tasks-location)" >> $GITHUB_ENV
          echo "CLOUD_TASKS_QUEUE=$(gcloud secrets versions access latest --secret=cloud-tasks-queue)" >> $GITHUB_ENV
          echo "HUB_CALLBACK_URL=$(gcloud secrets versions access latest --secret=hub-callback-url)" >> $GITHUB_ENV
          echo "HUB_CALLBACK_SECRET=$(gcloud secrets versions access latest --secret=hub-callback-secret)" >> $GITHUB_ENV

      - name: Build container image
        run: |
          # Use --async to avoid log streaming permission issues with Workload Identity
          BUILD_ID=$(gcloud builds submit \
            --tag gcr.io/$GOOGLE_CLOUD_PROJECT/podcast-api \
            --timeout=20m \
            --project $GOOGLE_CLOUD_PROJECT \
            --async \
            --format='value(id)')

          echo "Build started: $BUILD_ID"

          # Poll for build completion
          while true; do
            STATUS=$(gcloud builds describe $BUILD_ID --project $GOOGLE_CLOUD_PROJECT --format='value(status)')
            echo "Build status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Build completed successfully"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "TIMEOUT" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi

            sleep 10
          done

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy podcast-api \
            --image gcr.io/$GOOGLE_CLOUD_PROJECT/podcast-api \
            --project $GOOGLE_CLOUD_PROJECT \
            --region $CLOUD_TASKS_LOCATION \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --timeout 600s \
            --max-instances 1 \
            --min-instances 0 \
            --cpu 4 \
            --set-env-vars "RACK_ENV=production" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT" \
            --set-env-vars "GOOGLE_CLOUD_BUCKET=$GOOGLE_CLOUD_BUCKET" \
            --set-env-vars "API_SECRET_TOKEN=$API_SECRET_TOKEN" \
            --set-env-vars "CLOUD_TASKS_LOCATION=$CLOUD_TASKS_LOCATION" \
            --set-env-vars "CLOUD_TASKS_QUEUE=$CLOUD_TASKS_QUEUE" \
            --set-env-vars "SERVICE_ACCOUNT_EMAIL=$SERVICE_ACCOUNT_EMAIL" \
            --set-env-vars "HUB_CALLBACK_URL=$HUB_CALLBACK_URL" \
            --set-env-vars "HUB_CALLBACK_SECRET=$HUB_CALLBACK_SECRET"

      - name: Update with SERVICE_URL
        run: |
          SERVICE_URL=$(gcloud run services describe podcast-api \
            --region $CLOUD_TASKS_LOCATION \
            --project $GOOGLE_CLOUD_PROJECT \
            --format 'value(status.url)')

          gcloud run services update podcast-api \
            --region $CLOUD_TASKS_LOCATION \
            --project $GOOGLE_CLOUD_PROJECT \
            --set-env-vars "RACK_ENV=production,GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT,GOOGLE_CLOUD_BUCKET=$GOOGLE_CLOUD_BUCKET,API_SECRET_TOKEN=$API_SECRET_TOKEN,CLOUD_TASKS_LOCATION=$CLOUD_TASKS_LOCATION,CLOUD_TASKS_QUEUE=$CLOUD_TASKS_QUEUE,SERVICE_ACCOUNT_EMAIL=$SERVICE_ACCOUNT_EMAIL,SERVICE_URL=$SERVICE_URL,HUB_CALLBACK_URL=$HUB_CALLBACK_URL,HUB_CALLBACK_SECRET=$HUB_CALLBACK_SECRET"
