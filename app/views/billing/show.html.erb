<div class="mx-auto max-w-4xl px-4 py-8">
  <%= render "shared/back_link", path: episodes_path, text: "Back to Episodes" %>
  <h1 class="font-display text-2xl tracking-tight text-mist-950 dark:text-white mb-10">Billing</h1>

  <div class="space-y-12">
    <%# Current Plan section %>
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 border-b border-mist-950/10 pb-12 md:grid-cols-3 dark:border-white/10">
      <div>
        <h2 class="text-base/7 font-semibold text-mist-950 dark:text-white">Current Plan</h2>
        <p class="mt-1 text-sm/6 text-mist-500 dark:text-mist-400">Manage your subscription and billing.</p>
      </div>
      <div class="md:col-span-2">
        <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-mist-950/5 dark:bg-mist-800 dark:ring-white/10">
          <% if Current.user.unlimited? %>
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-mist-950 dark:text-white">
                <span class="text-red-600 dark:text-red-400">U</span><span class="text-orange-500">n</span><span class="text-yellow-500 dark:text-yellow-300">l</span><span class="text-green-600 dark:text-green-400">i</span><span class="text-teal-500">m</span><span class="text-blue-500">i</span><span class="text-indigo-400">t</span><span class="text-red-600 dark:text-red-400">e</span><span class="text-orange-500">d</span>
              </h3>
              <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 dark:bg-green-500/10 dark:text-green-400">Active</span>
            </div>
            <p class="mt-2 text-sm/6 text-mist-500 dark:text-mist-400">You have unlimited access with no restrictions.</p>

          <% elsif Current.user.complimentary? %>
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-mist-950 dark:text-white">Premium</h3>
              <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 dark:bg-green-500/10 dark:text-green-400">Complimentary</span>
            </div>
            <p class="mt-2 text-sm/6 text-mist-500 dark:text-mist-400">You have complimentary premium access.</p>

          <% elsif @subscription&.active? %>
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-mist-950 dark:text-white">Premium</h3>
              <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 dark:bg-green-500/10 dark:text-green-400">Active</span>
            </div>
            <p class="mt-2 text-sm/6 text-mist-500 dark:text-mist-400">
              <%= @subscription.canceling? ? "Ends" : "Renews" %> on <%= (@subscription.canceling? ? @subscription.cancel_at : @subscription.current_period_end).strftime("%B %d, %Y") %>
            </p>
            <div class="mt-4">
              <%= button_to "Manage Subscription", portal_session_path, class: button_classes(type: :secondary), data: { turbo: false } %>
            </div>

          <% elsif @subscription&.past_due? %>
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-mist-950 dark:text-white">Premium</h3>
              <span class="inline-flex items-center rounded-full bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700 dark:bg-yellow-500/10 dark:text-yellow-400">Past Due</span>
            </div>
            <p class="mt-2 text-sm/6 text-mist-500 dark:text-mist-400">Please update your payment method to restore Premium access.</p>
            <div class="mt-4">
              <%= button_to "Fix Payment", portal_session_path, class: button_classes(type: :primary), data: { turbo: false } %>
            </div>

          <% elsif @subscription&.canceled? %>
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-mist-950 dark:text-white">Premium</h3>
              <span class="inline-flex items-center rounded-full bg-mist-100 px-2 py-1 text-xs font-medium text-mist-600 dark:bg-mist-500/10 dark:text-mist-400">Canceled</span>
            </div>
            <p class="mt-2 text-sm/6 text-mist-500 dark:text-mist-400">
              Your subscription ended on <%= @subscription.current_period_end.strftime("%B %d, %Y") %>.
            </p>

          <% elsif Current.user.has_credits? %>
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-mist-950 dark:text-white">Free + Credits</h3>
              <span class="inline-flex items-center rounded-full bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 dark:bg-blue-500/10 dark:text-blue-400">Active</span>
            </div>
            <p class="mt-2 text-sm/6 text-mist-500 dark:text-mist-400">
              You have <span class="font-medium text-mist-950 dark:text-white"><%= Current.user.credits_remaining %> episode credits</span> remaining.
            </p>
            <div class="mt-4">
              <%= form_with url: checkout_path, method: :post, data: { turbo: false } do |form| %>
                <%= form.hidden_field :price_id, value: AppConfig::Stripe::PRICE_ID_CREDIT_PACK %>
                <%= form.submit "Buy More Credits", class: button_classes(type: :secondary) %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <% if @subscription&.canceled? %>
      <%# Upgrade section for canceled users %>
      <div class="grid grid-cols-1 gap-x-8 gap-y-10 md:grid-cols-3">
        <div>
          <h2 class="text-base/7 font-semibold text-mist-950 dark:text-white">Resubscribe</h2>
          <p class="mt-1 text-sm/6 text-mist-500 dark:text-mist-400">Pick up where you left off with a new subscription.</p>
        </div>
        <div class="md:col-span-2">
          <%= render "upgrade_options" %>
        </div>
      </div>
    <% elsif Current.user.has_credits? && !Current.user.premium? %>
      <%# Upgrade section for credit users %>
      <div class="grid grid-cols-1 gap-x-8 gap-y-10 md:grid-cols-3">
        <div>
          <h2 class="text-base/7 font-semibold text-mist-950 dark:text-white">Save with Premium</h2>
          <p class="mt-1 text-sm/6 text-mist-500 dark:text-mist-400">Unlimited episodes for less than 2 credit packs per month.</p>
        </div>
        <div class="md:col-span-2">
          <%= render "upgrade_options" %>
        </div>
      </div>
    <% end %>
  </div>
</div>
