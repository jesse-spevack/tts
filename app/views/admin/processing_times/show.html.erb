<div class="max-w-4xl mx-auto">
  <h1 class="text-3xl font-semibold mb-8">Processing Times</h1>

  <div class="flex flex-col gap-3">
    <!-- Scatter Plot -->
    <%= render "shared/card", padding: "p-6" do %>
      <h2 class="text-lg font-semibold mb-4">Processing Time vs. Text Length</h2>
      <% if @chart_points.any? %>
        <%
          max_length = @chart_points.map { |p| p[:length] }.max.to_f
          max_seconds = @chart_points.map { |p| p[:seconds] }.max.to_f

          # Calculate outlier threshold (2x median)
          sorted_seconds = @chart_points.map { |p| p[:seconds] }.sort
          median_seconds = sorted_seconds[sorted_seconds.length / 2]
          outlier_threshold = median_seconds * 4

          chart_w = 700
          chart_h = 350
          pad_left = 60
          pad_bottom = 50
          pad_top = 20
          pad_right = 20
          plot_w = chart_w - pad_left - pad_right
          plot_h = chart_h - pad_top - pad_bottom
        %>
        <svg viewBox="0 0 <%= chart_w %> <%= chart_h %>" class="w-full h-auto" role="img" aria-label="Scatter plot of processing time versus source text length">
          <!-- Axes -->
          <line x1="<%= pad_left %>" y1="<%= pad_top %>" x2="<%= pad_left %>" y2="<%= chart_h - pad_bottom %>" stroke="currentColor" stroke-opacity="0.3" />
          <line x1="<%= pad_left %>" y1="<%= chart_h - pad_bottom %>" x2="<%= chart_w - pad_right %>" y2="<%= chart_h - pad_bottom %>" stroke="currentColor" stroke-opacity="0.3" />

          <!-- Y-axis ticks and labels -->
          <% 5.times do |i| %>
            <%
              tick_val = (max_seconds / 4.0 * i).round(1)
              tick_y = chart_h - pad_bottom - (plot_h * i / 4.0)
            %>
            <line x1="<%= pad_left - 4 %>" y1="<%= tick_y %>" x2="<%= pad_left %>" y2="<%= tick_y %>" stroke="currentColor" stroke-opacity="0.3" />
            <line x1="<%= pad_left %>" y1="<%= tick_y %>" x2="<%= chart_w - pad_right %>" y2="<%= tick_y %>" stroke="currentColor" stroke-opacity="0.08" />
            <text x="<%= pad_left - 8 %>" y="<%= tick_y + 4 %>" text-anchor="end" fill="currentColor" fill-opacity="0.5" font-size="11"><%= tick_val %>s</text>
          <% end %>

          <!-- X-axis ticks and labels -->
          <% 5.times do |i| %>
            <%
              tick_val = (max_length / 4.0 * i).round(0).to_i
              tick_x = pad_left + (plot_w * i / 4.0)
            %>
            <line x1="<%= tick_x %>" y1="<%= chart_h - pad_bottom %>" x2="<%= tick_x %>" y2="<%= chart_h - pad_bottom + 4 %>" stroke="currentColor" stroke-opacity="0.3" />
            <text x="<%= tick_x %>" y="<%= chart_h - pad_bottom + 18 %>" text-anchor="middle" fill="currentColor" fill-opacity="0.5" font-size="11"><%= number_to_human(tick_val, precision: 2, significant: true) %></text>
          <% end %>

          <!-- Axis labels -->
          <text x="<%= chart_w / 2 %>" y="<%= chart_h - 5 %>" text-anchor="middle" fill="currentColor" fill-opacity="0.6" font-size="12">Source Text Length (characters)</text>
          <text x="15" y="<%= chart_h / 2 %>" text-anchor="middle" fill="currentColor" fill-opacity="0.6" font-size="12" transform="rotate(-90, 15, <%= chart_h / 2 %>)">Processing Time (seconds)</text>

          <!-- Data points -->
          <% @chart_points.each do |point| %>
            <%
              x = pad_left + (point[:length] / max_length * plot_w)
              y = chart_h - pad_bottom - (point[:seconds] / max_seconds * plot_h)
              is_outlier = point[:seconds] > outlier_threshold
            %>
            <circle
              cx="<%= x %>"
              cy="<%= y %>"
              r="<%= is_outlier ? 5 : 4 %>"
              fill="<%= is_outlier ? '#ef4444' : '#6366f1' %>"
              fill-opacity="<%= is_outlier ? 0.5 : 0.6 %>"
              stroke="<%= is_outlier ? '#ef4444' : '#6366f1' %>"
              stroke-opacity="0.8"
              stroke-width="1"
            >
              <title><%= point[:title] %> â€” <%= number_to_human(point[:length], precision: 2, significant: true) %> chars, <%= point[:seconds].round(1) %>s</title>
            </circle>
          <% end %>
        </svg>
        <div class="flex items-center gap-4 mt-2 text-xs text-mist-500 dark:text-mist-400">
          <span class="flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-full bg-indigo-500 opacity-60"></span>
            Normal
          </span>
          <span class="flex items-center gap-1">
            <span class="inline-block w-3 h-3 rounded-full bg-red-500 opacity-50"></span>
            Outlier (>4x median)
          </span>
          <span class="ml-auto">
            <%= @chart_points.size %> episodes<% if @total_episode_count > @chart_points.size %> (of <%= @total_episode_count %> total)<% end %>
          </span>
        </div>
      <% else %>
        <p class="py-4 text-center text-mist-500 dark:text-mist-400">No completed episodes with processing data yet</p>
      <% end %>
    <% end %>

    <!-- Current Estimate Model -->
    <%= render "shared/card", padding: "p-6" do %>
      <h2 class="text-lg font-semibold mb-4">Current Estimate Model</h2>
      <% if @current_estimate %>
        <table class="w-full text-sm">
          <tr>
            <td class="py-1 text-mist-500 dark:text-mist-400">Base seconds</td>
            <td class="py-1 text-right font-medium"><%= @current_estimate.base_seconds %></td>
          </tr>
          <tr>
            <td class="py-1 text-mist-500 dark:text-mist-400">Microseconds per character</td>
            <td class="py-1 text-right font-medium"><%= @current_estimate.microseconds_per_character %></td>
          </tr>
          <tr>
            <td class="py-1 text-mist-500 dark:text-mist-400">Episode count used</td>
            <td class="py-1 text-right font-medium"><%= @current_estimate.episode_count %></td>
          </tr>
          <tr>
            <td class="py-1 text-mist-500 dark:text-mist-400">Last recalculated</td>
            <td class="py-1 text-right font-medium"><%= time_ago_in_words(@current_estimate.created_at) %> ago</td>
          </tr>
        </table>
      <% else %>
        <p class="py-4 text-center text-mist-500 dark:text-mist-400">No estimate model calculated yet</p>
      <% end %>
    <% end %>

    <!-- Estimate History -->
    <%= render "shared/card", padding: "p-6" do %>
      <h2 class="text-lg font-semibold mb-4">Estimate History (last 10)</h2>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-mist-200 dark:border-mist-700">
            <th class="py-2 text-left text-mist-500 dark:text-mist-400">Date</th>
            <th class="py-2 text-right text-mist-500 dark:text-mist-400">Base (s)</th>
            <th class="py-2 text-right text-mist-500 dark:text-mist-400">&micro;s/char</th>
            <th class="py-2 text-right text-mist-500 dark:text-mist-400">Episodes</th>
          </tr>
        </thead>
        <tbody>
          <% @estimate_history.each do |estimate| %>
            <tr class="border-b border-mist-200 dark:border-mist-700">
              <td class="py-2"><%= estimate.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              <td class="py-2 text-right font-medium"><%= estimate.base_seconds %></td>
              <td class="py-2 text-right font-medium"><%= estimate.microseconds_per_character %></td>
              <td class="py-2 text-right font-medium"><%= estimate.episode_count %></td>
            </tr>
          <% end %>
          <% if @estimate_history.empty? %>
            <tr>
              <td colspan="4" class="py-4 text-center text-mist-500 dark:text-mist-400">No estimate history yet</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>
