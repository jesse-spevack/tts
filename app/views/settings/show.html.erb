<div class="max-w-2xl mx-auto">
  <%= render "shared/back_link", path: episodes_path, text: "Back to Episodes" %>
  <%= render "shared/page_header", title: "Settings" %>

  <div class="space-y-6">
  <%= render "shared/card", padding: "p-4 sm:p-8" do %>
    <%= form_with url: settings_path, method: :patch, class: "space-y-6" do %>
      <h2 class="text-lg font-medium">Voice</h2>
      <p class="text-[var(--color-subtext)] text-sm">Choose the voice for your podcast episodes.</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <% @voices.each do |voice| %>
          <label class="group relative flex rounded-lg border-2 p-4 cursor-pointer transition-colors
                        border-[var(--color-overlay0)] bg-[var(--color-surface)]
                        has-[:checked]:border-[var(--color-primary)] has-[:checked]:bg-[var(--color-primary)]/5">
            <input type="radio" name="voice" value="<%= voice[:key] %>"
                   <%= "checked" if @selected_voice == voice[:key] %>
                   class="absolute inset-0 appearance-none focus:outline-none cursor-pointer">
            <div class="flex-1">
              <span class="block font-medium"><%= voice[:name] %></span>
              <span class="mt-1 block text-sm text-[var(--color-subtext)]">
                <%= voice[:accent] %> &middot; <%= voice[:gender] %>
              </span>
              <div data-controller="audio-preview" data-audio-preview-url-value="<%= voice[:sample_url] %>" class="mt-3 flex items-center gap-3 relative z-10">
                <button type="button"
                        data-audio-preview-target="button"
                        data-action="click->audio-preview#toggle"
                        class="text-sm text-[var(--color-primary)] hover:opacity-70 inline-flex items-center gap-1">
                  <span data-audio-preview-target="playIcon"><%= render "shared/icons/play" %></span>
                  <span data-audio-preview-target="pauseIcon" class="hidden"><%= render "shared/icons/pause" %></span>
                  Preview
                </button>
                <button type="button"
                        data-action="click->audio-preview#restart"
                        class="text-[var(--color-subtext)] hover:text-[var(--color-text)]"
                        title="Restart">
                  <%= render "shared/icons/restart" %>
                </button>
              </div>
            </div>
            <span class="invisible text-[var(--color-primary)] group-has-[:checked]:visible">
              <%= render "shared/icons/check_circle_solid" %>
            </span>
          </label>
        <% end %>
      </div>

      <%= submit_tag "Save Changes", class: button_classes(type: :primary) %>
    <% end %>
  <% end %>

  <% if Current.user.premium? %>
    <%= render "shared/card", padding: "p-4 sm:p-8" do %>
      <h2 class="text-lg font-medium mb-2">Billing</h2>
      <p class="text-[var(--color-subtext)] text-sm mb-4">Manage your subscription and payment details.</p>
      <%= link_to "Manage Billing", billing_path, class: button_classes(type: :secondary) %>
    <% end %>
  <% end %>

  <%= render "shared/card", padding: "p-4 sm:p-8" do %>
    <h2 class="text-lg font-medium mb-2">Browser Extension</h2>
    <p class="text-[var(--color-subtext)] text-sm mb-4">Send articles to your podcast from any webpage.</p>
    <%= link_to "Manage Extension", settings_extensions_path, class: button_classes(type: :secondary) %>
  <% end %>

  <%= render "shared/card", padding: "p-4 sm:p-8" do %>
    <h2 class="text-lg font-medium mb-2">Email to Podcast</h2>

    <% if Current.user.email_episodes_enabled? %>
      <p class="text-[var(--color-subtext)] text-sm mb-4">
        Send content to this address to create podcast episodes:
      </p>

      <div class="flex items-center gap-2 mb-4">
        <code class="flex-1 bg-[var(--color-surface)] border border-[var(--color-overlay0)] rounded-md px-3 py-2 text-sm font-mono break-all">
          <%= Current.user.email_ingest_address %>
        </code>
        <button type="button"
                data-controller="clipboard"
                data-clipboard-text-value="<%= Current.user.email_ingest_address %>"
                data-action="clipboard#copy"
                class="<%= button_classes(type: :secondary) %>">
          Copy
        </button>
      </div>

      <div class="flex flex-wrap gap-2 mb-4">
        <%= button_to "Regenerate Address", regenerate_email_token_settings_path,
            method: :post, class: button_classes(type: :secondary),
            data: { turbo_confirm: "This will invalidate your current email address. Continue?" } %>
        <%= button_to "Disable", disable_email_episodes_settings_path,
            method: :post, class: button_classes(type: :danger) %>
      </div>

      <div class="border-t border-[var(--color-overlay0)] pt-4">
        <%= form_with url: settings_path, method: :patch do %>
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="hidden" name="email_episode_confirmation" value="0">
            <input type="checkbox" name="email_episode_confirmation" value="1"
                   <%= "checked" if Current.user.email_episode_confirmation? %>
                   class="w-5 h-5 rounded border-[var(--color-overlay0)] text-[var(--color-primary)] focus:ring-[var(--color-primary)]">
            <span class="text-sm">Send confirmation email when episodes are created</span>
          </label>

          <%= submit_tag "Save", class: "#{button_classes(type: :primary)} mt-4" %>
        <% end %>
      </div>
    <% else %>
      <p class="text-[var(--color-subtext)] text-sm mb-4">
        Enable email episodes to get a unique email address for creating episodes by forwarding content.
      </p>

      <%= button_to "Enable Email Episodes", enable_email_episodes_settings_path,
          method: :post, class: button_classes(type: :primary) %>
    <% end %>
  <% end %>
  </div>
</div>
