#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../config/environment"

url = ARGV[0] || "https://world.hey.com/dhh/no-backup-no-cry-274e0c31"

puts "Testing URL Processing Pipeline"
puts "=" * 60
puts "URL: #{url}"
puts "=" * 60

# Step 1: Fetch URL
puts "\n1. FETCHING URL..."
fetch_result = UrlFetcher.call(url: url)

if fetch_result.failure?
  puts "✗ Fetch failed: #{fetch_result.error}"
  exit 1
end

puts "✓ Fetched #{fetch_result.html.bytesize} bytes"

# Step 2: Extract Article
puts "\n2. EXTRACTING ARTICLE..."
extract_result = ArticleExtractor.call(html: fetch_result.html)

if extract_result.failure?
  puts "✗ Extraction failed: #{extract_result.error}"
  exit 1
end

puts "✓ Extracted #{extract_result.character_count} characters"
puts "\n--- Extracted Text (first 500 chars) ---"
puts extract_result.text[0..500]
puts "..."
puts "--- End Preview ---"

# Step 3: LLM Processing
puts "\n3. PROCESSING WITH LLM..."

# Create a temporary episode for testing
user = User.first
podcast = user.podcasts.first

episode = Episode.new(
  podcast: podcast,
  user: user,
  title: "Test",
  author: "Test",
  description: "Test",
  source_type: :url,
  source_url: url,
  status: :processing
)

llm_result = LlmProcessor.call(text: extract_result.text, episode: episode, user: user)

if llm_result.failure?
  puts "✗ LLM processing failed: #{llm_result.error}"
  exit 1
end

puts "✓ LLM processing complete"
puts "\n--- LLM Result ---"
puts "Title: #{llm_result.title}"
puts "Author: #{llm_result.author}"
puts "Description: #{llm_result.description}"
puts "\n--- Content (first 1000 chars) ---"
puts llm_result.content[0..1000]
puts "..."
puts "--- End Preview ---"

puts "\n" + "=" * 60
puts "✓ Pipeline complete!"
